<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head th:replace="fragments/common-head :: common-head">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<h1>Editar Comanda</h1>
<div th:replace="fragments/navbar :: navbar"></div>
<form action="#" th:action="@{/comanda/edit/{id}(id=${comanda.id})}" th:object="${comanda}" method="post">
    <div class="row">
        <div class="col-md-3 col-sm-6">
            <div class="form-group">
                <label for="id">ID Comanda</label>
                <input type="text" id="id" th:field="*{id}" class="form-control" readonly />
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="form-group">
                <label for="mesa">Mesa</label>
                <span th:text="${comanda.mesa.id + ' - ' + comanda.mesa.locationUrl + ' - ' + comanda.mesa.numComensales}" class="form-control" readonly></span>
            </div>                              
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="form-group">
                <label for="camarero">ID Camarero</label>
                <input type="text" id="camarero" th:field="*{idCamarero.id}" class="form-control" readonly />
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="form-group">
                <label for="numComensales">Número de comensales</label>
                <input type="number" id="numComensales" th:field="*{numComensales}" class="form-control" />
            </div>
        </div>
    </div>
    <!-- Aquí puedes agregar más campos para otras propiedades de Comanda -->

    <h5>Añadir Líneas de Comanda</h5>
    <div id="lineaComandaContainer">
        <!-- Los formularios se agregarán aquí mediante JavaScript -->
    </div>
    <button type="button" id="addLineaComandaButton" class="btn btn-primary">Añadir Línea de Comanda</button>
    <a th:href="@{/comanda/delete/{id}(id=${comanda.id})}" class="btn btn-danger">Eliminar</a>
    <style>
        .form-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
    
        .form-row div {
            flex: 1;
        }
    </style>
    
    <script th:inline="javascript">
        /*<![CDATA[*/
        function createForm(fields, productos) {
            var form = document.createElement("form");
            form.action = "/lineaComanda/add";
            form.method = "post";
            form.className = "form-row";
            fields.forEach(function (field) {
                form.appendChild(createFieldDiv(field, productos));
            });
            var submitButton = createButton("submit", "Guardar", "btn btn-primary");
            form.appendChild(submitButton);
            return form;
        }
    
        function createFieldDiv(field, productos) {
            var div = document.createElement("div");
            var label = createLabel(field);
            div.appendChild(label);
            var input = (field === "producto") ? createProductSelect(productos) : createInput(field);
            div.appendChild(input);
            return div;
        }
    
        function createLabel(field) {
            var label = document.createElement("label");
            label.for = field;
            label.textContent = field.charAt(0).toUpperCase() + field.slice(1);
            return label;
        }
    
        function createProductSelect(productos) {
            var select = document.createElement("select");
            select.className = "form-control";
            if (productos && productos.length > 0)  {
                productos.forEach(function(producto) {
                    console.log('Creating option for producto:', producto); // debug line
                    var option = document.createElement("option");
                    option.value = producto.id;
                    option.textContent = producto.nombre;
                    select.appendChild(option);
                });
            } else {
                console.log('No productos available.'); // debug line
            }
            return select;
        }
    
        function createInput(field) {
            var input = document.createElement("input");
            input.type = (field === "importe" || field === "iva" || field === "total") ? "number" : "text";
            input.className = "form-control";
            input.id = field;
            input.name = field;
            return input;
        }
    
        function createButton(type, textContent, className) {
            var button = document.createElement("button");
            button.type = type;
            button.textContent = textContent;
            button.className = className;
            return button;
        }
    
        document.addEventListener("DOMContentLoaded", function() {
            var productos = [];
            try {
                productos = JSON.parse(/*[[${productosJson}]]*/);
                console.log('Productos parseados:', productos);
            } catch (error) {
                console.error("Error parsing productosJson:", error);
            }
    
            document.getElementById("addLineaComandaButton").addEventListener("click", function () {
                var container = document.getElementById("lineaComandaContainer");
                var fields = ["producto", "unidades", "concepto", "estado", "importe", "iva", "total"];
                var form = createForm(fields, productos);
                container.appendChild(form);
    
                var deleteButton = createButton("button", "Eliminar", "btn btn-danger");
                deleteButton.addEventListener("click", function () {
                    container.removeChild(form);
                });
                form.appendChild(deleteButton);
            });
        });
        /*]]>*/
    </script>
    

</body>
</html>
